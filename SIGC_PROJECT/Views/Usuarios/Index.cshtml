@model IPagedList<SIGC_PROJECT.Models.Usuario>

@using X.PagedList;
@using X.PagedList.Mvc.Core;

@{
    ViewData["Title"] = "Index";
}

<div style="margin-top: 8%;"></div>
<div class="row mt-4 mb-4">
    <div class="col-md-6 d-flex align-items-center">
        <a asp-controller="RegistrosUsuario" asp-action="RegistroUsuario" class="btn btn-estilo">Registrar Usuario</a>
    </div>

    <div class="col-md-6 d-flex justify-content-end align-items-center">
        <label for="buscarRol" class="control-label me-2 mb-0 mr-1" style="font-weight: bold; color: #04294F;">Buscar por Rol:</label>
        <select id="buscarRol" class="form-control w-auto">
            <option value="" selected>Todos los roles</option>
            <option value="Administrador">Administrador</option>
            <option value="Doctor">Doctor</option>
            <option value="Secretaria">Secretaria</option>
            <option value="Paciente">Paciente</option>
        </select>
    </div>
</div>

<table class="table table-striped w-100">
    <thead>
        <tr class="th_bg">
            <th>
                Nombre de Usuario
            </th>
            <th>
                Último Acesso
            </th>
            <th>
                Rol del Usuario
            </th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr class="font-weight-bold">
            <td>
                @Html.DisplayFor(modelItem => item.NombreUsuario)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.FechaUltimoAcceso)
            </td>
            <td>
                    @foreach(var ur in item.UsuarioRoles)
                    {
                        @ur.Rol.Nombre
                    }
            </td>
        </tr>
}
    </tbody>
</table>

<div class="contenedor-paginacion">
    @Html.PagedListPager(Model, pagina => Url.Action("Index", new { pagina = pagina, rol = ViewBag.Rol }), new PagedListRenderOptions
    {
        DisplayPageCountAndCurrentLocation = false,
        DisplayLinkToFirstPage = PagedListDisplayMode.Always,
        DisplayLinkToLastPage = PagedListDisplayMode.Always,
        DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
        DisplayLinkToNextPage = PagedListDisplayMode.Always,
        DisplayLinkToIndividualPages = true,
        MaximumPageNumbersToDisplay = 10,
        DisplayEllipsesWhenNotShowingAllPageNumbers = true,
        Display = PagedListDisplayMode.Always,

        UlElementClasses = new[] { "pagination", "justify-content-center" },
        LiElementClasses = new[] { "page-item" },
        PageClasses = new[] { "page-link" }
    })

    <div class="paginacion_dabajo">
        @string.Format("Página {0} de {1}", Model.PageNumber, Model.PageCount)
    </div>
</div>

@section Scripts { 

    @*========== FUNCIONALIDADES ==========*@
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var searchInput = document.getElementById('buscarRol');

            //Evento input del campo
            searchInput.addEventListener('change', function (e) {
                var valor = searchInput.value;

                var searchParams = new URLSearchParams(window.location.search);
                searchParams.set('rol', valor);
                searchParams.set('pagina', 1); // Resetear a la primera página

                //Enviar Solicitud Ajax al controlador
                fetch(window.location.pathname + '?' + searchParams.toString())
                    .then(response => response.text())
                    .then(html => {
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');
                        var nuevaTabla = doc.querySelector('tbody').innerHTML;
                        document.querySelector('tbody').innerHTML = nuevaTabla;
                        var newPagination = doc.querySelector('.contenedor-paginacion').innerHTML;
                        document.querySelector('.contenedor-paginacion').innerHTML = newPagination;
                    })
                    .catch(error => console.error('Error al buscar pacientes:', error));
            });

        });
    </script>
    @*=====================================*@

    @*========== ESTILOS ==========*@
    <style>
        .paginacion_dabajo {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }

        .contenedor-paginacion {
            text-align: center;
        }

        .active.page-item .page-link {
            background-color: #4a7cba !important;
            font-weight: bold;
            border: 2px solid #4a7cba !important;
            text-shadow: 1px 1px 2px #3e536d;
        }

        .th_bg {
            background-color: #4a7cba;
            color: #FFFFFF;
            font-weight: bold;
            text-shadow: 1px 1px 2px #3e536d;
        }

        th {
            border: 1px solid #FFFFFF;
        }

        .btn-estilo {
            background-color: #4a7cba;
            color: #FFFFFF;
            transition: background-color 0.5s linear;
            width: 40%;
            font-weight: bold;
            font-size: 1.1em;
        }

        .btn-estilo:hover {
            background-color: #82a9da;
            color: #FFFFFF;
            text-shadow: 1px 1px 2px #3e536d;
        }
    </style>
    @*=============================*@
}