@model IPagedList<SIGC_PROJECT.Models.Paciente>

@using X.PagedList;
@using X.PagedList.Mvc.Core;

@{
    ViewData["Title"] = "Index";
}

<div class="mt-3" style="color: transparent;">4</div>
<div class="row mt-4 mb-4">
    
    @if (User.IsInRole("Administrador"))
    {
        <div class="col-md-6 d-flex align-items-center">
        </div>
    }

    @if (User.IsInRole("Secretaria"))
    {
        <div class="col-md-6 d-flex align-items-center">
            <a asp-controller="Secretariums" asp-action="RegistrarPaciente" class="btn btn-estilo">Agregar Paciente</a>
        </div>
    }
        
    <div class="col-md-6 d-flex justify-content-end align-items-center">
        <label for="buscarCedula" class="control-label me-2 mb-0 mr-1" style="font-weight: bold; color: #04294F;">Buscar por Cédula:</label>
        <input type="text" id="buscarCedula" class="form-control w-auto" />
    </div>
</div>

<table class="table table-striped w-100">
    <thead>
        <tr class="th_bg">
            <th>Cédula</th>
            <th>Nombre Completo</th>
            <th>Fecha de Naciemiento</th>
            <th>Edad</th>
            <th>Género</th>
            <th hidden>Dirección</th>
            <th hidden>Télefono</th>
            <th hidden>Correo Electrónico</th>
            <th hidden>Historial Médico</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="pacienteTableBody">
        @foreach (var item in Model) {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.Cedula)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Nombre) @Html.DisplayFor(modelItem => item.Apellido)
                    </td>
                    <td>
                        @(item.FechaNacimiento.HasValue ? item.FechaNacimiento.Value.ToString("dd/MM/yyyy") : "No disponible")
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Edad)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Genero)
                    </td>
                    <td hidden>
                        @Html.DisplayFor(modelItem => item.Direccion)
                    </td>
                    <td hidden>
                        @Html.DisplayFor(modelItem => item.Telefono)
                    </td>
                    <td hidden>
                        @Html.DisplayFor(modelItem => item.CorreoElectronico)
                    </td>
                    <td hidden>
                        @Html.DisplayFor(modelItem => item.HistorialMedico)
                    </td>
                    @if (User.IsInRole("Administrador"))
                    {
                        <td class="text-center">
                            <a asp-action="Details" data-toggle="tooltip" title="Detalles" class=" btn btn-primary" asp-route-id="@item.PacienteId"><i class="fa fa-info-circle"></i></a>
                            <a asp-action="Delete" data-toggle="tooltip" title="Eliminar" class=" btn btn-danger" asp-route-id="@item.PacienteId"><i class="fa fa-trash"></i></a>
                        </td>
                    }
            
                    @if (User.IsInRole("Secretaria"))
                    {
                        <td class="text-center">
                            <a asp-action="Details" class=" btn btn-primary font-weight-bold" style="font-size: 1.2em;" asp-route-id="@item.PacienteId">Ver Detalles</a>
                        </td>
                    }
                </tr>
        }
    </tbody>
</table>

<div class="contenedor-paginacion">
    @Html.PagedListPager(Model, pagina => Url.Action("Index", new { pagina = pagina, cedula = ViewBag.Cedula }), new PagedListRenderOptions
{

    DisplayPageCountAndCurrentLocation = false,
    DisplayLinkToFirstPage = PagedListDisplayMode.Always,
    DisplayLinkToLastPage = PagedListDisplayMode.Always,
    DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
    DisplayLinkToNextPage = PagedListDisplayMode.Always,
    DisplayLinkToIndividualPages = true,
    MaximumPageNumbersToDisplay = 10,
    DisplayEllipsesWhenNotShowingAllPageNumbers = true,
    Display = PagedListDisplayMode.Always,

    UlElementClasses = new[] { "pagination", "justify-content-center" },
    LiElementClasses = new[] { "page-item" },
    PageClasses = new[] { "page-link" }
})

    <div class="paginacion_dabajo">
        @string.Format("Página {0} de {1}", Model.PageNumber, Model.PageCount)
    </div>
</div>

@section Scripts { 

    @*========== FUNCIONALIDADES ==========*@
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var searchInput = document.getElementById('buscarCedula');

            //Funcion para formatear el campo de cedula
            function formatearCedula(valor, cursorPos) {
                var valorNumerico = valor.replace(/\D/g, '');
                var valorFormateado = '';

                if (valorNumerico.length > 0) {
                    valorFormateado += valorNumerico.substr(0, 3);
                }
                if (valorNumerico.length >= 4) {
                    valorFormateado += '-' + valorNumerico.substr(3, 7);
                }
                if (valorNumerico.length >= 11) {
                    valorFormateado += '-' + valorNumerico.substr(10, 1);
                }

                return valorFormateado;
            }

            //Evento input del campo
            searchInput.addEventListener('input', function (e) {
                var valor = searchInput.value;
                var cursorPos = searchInput.selectionStart; // Obtener la posición del cursor
                var valorFormateado = formatearCedula(valor, cursorPos);

                // Actualizar el valor del campo
                searchInput.value = valorFormateado;

                // Restaurar la posición del cursor
                var newCursorPos = cursorPos;
                if (valor.length < valorFormateado.length) {
                    newCursorPos++;
                }
                searchInput.setSelectionRange(newCursorPos, newCursorPos);

                var searchParams = new URLSearchParams(window.location.search);
                searchParams.set('cedula', valorFormateado);
                searchParams.set('pagina', 1); // Resetear a la primera página

                //Enviar Solicitud Ajax al controlador
                fetch(window.location.pathname + '?' + searchParams.toString())
                    .then(response => response.text())
                    .then(html => {
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');
                        var nuevaTabla = doc.querySelector('tbody').innerHTML;
                        document.querySelector('tbody').innerHTML = nuevaTabla;
                        var newPagination = doc.querySelector('.contenedor-paginacion').innerHTML;
                        document.querySelector('.contenedor-paginacion').innerHTML = newPagination;
                    })
                    .catch(error => console.error('Error al buscar pacientes:', error));
            });

        });
    </script>
    @*=====================================*@

    @*========== ESTILOS ==========*@
    <style>
        .paginacion_dabajo {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }

        .contenedor-paginacion {
            text-align: center;
        }

        .active.page-item .page-link {
            background-color: rgba(42, 62, 84, 1) !important;
            font-weight: bold;
            border: 2px solid rgba(42, 62, 84, 1) !important;
        }

        .th_bg {
            background-color: rgba(42, 62, 84, 1);
            color: #FFFFFF;
        }

        th {
            border: 1px solid #FFFFFF;
        }

        .btn-estilo {
            background-color: rgba(42, 62, 84, 1);
            color: #FFFFFF;
            transition: background-color 0.5s linear;
            width: 40%;
            font-weight: bold;
            font-size: 1.1em;
        }

        .btn-estilo:hover {
            background-color: #062043;
            color: #FFFFFF;
        }
    </style>
    @*=============================*@
}