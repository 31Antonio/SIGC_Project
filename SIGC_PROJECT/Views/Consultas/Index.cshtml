@model IPagedList<SIGC_PROJECT.Models.ViewModel.ConsultaGeneralVM>

@using X.PagedList;
@using X.PagedList.Mvc.Core;

@{
    ViewData["Title"] = "Index";
}
<div style="margin-top: 7%;"></div>
<h2 style="font-weight: bold; font-size: 1.7em; color: #04294F;" class="mt-5 mb-5">Historial de Consultas</h2>

<div class="row mt-4 mb-4">

    @if (User.IsInRole("Doctor"))
    {
        <div class="col-md-6 d-flex align-items-center">
            <a asp-action="Create" class="btn btn-estilo">Crear Registro</a>
        </div>
    }

    @if (User.IsInRole("Secretaria"))
    {
        <div class="col-md-6 d-flex align-items-center">
        </div>
    }

    <div class="col-md-6 d-flex justify-content-end align-items-center">
        <label for="buscarPaciente" class="control-label me-2 mb-0 mr-1" style="font-weight: bold; color: #04294F;">Buscar Paciente:</label>
        <input type="text" id="buscarPaciente" class="form-control w-auto" placeholder="Nombre del paciente..."/>
    </div>

</div>


<table class="table table-striped w-100">
    <thead>
        <tr class="th_bg">
            <th>Fecha</th>
            <th>Motivo de la consulta</th>
            <th>Nombre del Paciente</th>
            <th hidden>@Html.DisplayNameFor(model => model.First().RecetaId)</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model) {
        <tr class="font-weight-bold">
            <td>
                @item.FechaConsulta.ToString("dd/MM/yyyy")
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.MotivoConsulta)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.NombrePaciente)
            </td>
            <td hidden>
                @Html.DisplayFor(modelItem => item.RecetaId)
            </td>
            <td class="text-center">
                    @if (User.IsInRole("Administrador"))
                    {
                        <a asp-action="Edit" class=" btn btn-warning" asp-route-id="@item.ConsultaId">Edit</a>
                        <a asp-action="Details" class=" btn btn-primary" asp-route-id="@item.ConsultaId">Details</a>
                        <a asp-action="Delete" class=" btn btn-danger" asp-route-id="@item.ConsultaId">Delete</a>
                    }

                    @if (User.IsInRole("Doctor") || User.IsInRole("Secretaria"))
                    {
                        <a asp-action="Details" class=" btn btn-primary font-weight-bold" asp-route-id="@item.ConsultaId">Ver Detalles</a>
                    }
            </td>
        </tr>
}
    </tbody>
</table>

<div class="contenedor-paginacion">
    @Html.PagedListPager(Model, pagina => Url.Action("Index", new { pagina = pagina, nombrePaciente = ViewBag.NombrePaciente }), new PagedListRenderOptions
{

    DisplayPageCountAndCurrentLocation = false,
    DisplayLinkToFirstPage = PagedListDisplayMode.Always,
    DisplayLinkToLastPage = PagedListDisplayMode.Always,
    DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
    DisplayLinkToNextPage = PagedListDisplayMode.Always,
    DisplayLinkToIndividualPages = true,
    MaximumPageNumbersToDisplay = 10,
    DisplayEllipsesWhenNotShowingAllPageNumbers = true,
    Display = PagedListDisplayMode.Always,

    UlElementClasses = new[] { "pagination", "justify-content-center" },
    LiElementClasses = new[] { "page-item" },
    PageClasses = new[] { "page-link" }
})

    <div class="paginacion_dabajo">
        @string.Format("Página {0} de {1}", Model.PageNumber, Model.PageCount)
    </div>
</div>

@section Scripts {

    @*========== FUNCIONALIDADES ==========*@
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            var searchInput = document.getElementById('buscarPaciente');

            //Evento input del campo
            searchInput.addEventListener('input', function (e) {
                var valor = searchInput.value;

                var searchParams = new URLSearchParams(window.location.search);
                searchParams.set('nombrePaciente', valor);
                searchParams.set('pagina', 1); // Resetear a la primera página

                //Enviar Solicitud Ajax al controlador
                fetch(window.location.pathname + '?' + searchParams.toString())
                    .then(response => response.text())
                    .then(html => {
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');
                        var nuevaTabla = doc.querySelector('tbody').innerHTML;
                        document.querySelector('tbody').innerHTML = nuevaTabla;
                        var newPagination = doc.querySelector('.contenedor-paginacion').innerHTML;
                        document.querySelector('.contenedor-paginacion').innerHTML = newPagination;
                    })
                    .catch(error => console.error('Error al buscar pacientes:', error));
            });

        });
    </script>
    @*=====================================*@

    <!-- Agregar estilos CSS -->
    <style>
        .paginacion_dabajo {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            color: #04294F;
        }

        .contenedor-paginacion {
            text-align: center;
        }

        .active.page-item .page-link {
            background-color: #4a7cba !important;
            font-weight: bold;
            border: 2px solid #4a7cba !important;
            text-shadow: 1px 1px 2px #3e536d;
        }

        .th_bg {
            background-color: #4a7cba;
            color: #FFFFFF;
            font-weight: bold;
            text-shadow: 1px 1px 2px #3e536d;
        }

        th {
            border: 1px solid #FFFFFF;
        }

        .btn-estilo {
            background-color: #4a7cba;
            color: #FFFFFF;
            transition: background-color 0.5s linear;
            width: 40%;
            font-weight: bold;
            font-size: 1.1em;
        }

        .btn-estilo:hover {
            background-color: #82a9da;
            color: #FFFFFF;
            text-shadow: 1px 1px 2px #3e536d;
        }
    </style>
}
